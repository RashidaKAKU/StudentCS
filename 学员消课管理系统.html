<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>学员消课管理系统</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#7f8c8d;
      --primary:#2b7bd3;
      --success:#2ecc71;
      --danger:#e74c3c;
      --radius:12px;
      --gap:0.75rem;
      --content-max:1200px;
      --footer-height:64px;
      --sidebar-w:240px;
      --panel-padding:1.25rem;
      --input-height:48px; /* baseline */
      --control-font-size:15px;
      --ui-scale: 1;
      --shadow-strong: 0 10px 30px rgba(11,32,68,0.12);
      --shadow-soft: 0 6px 18px rgba(12,40,80,0.06);
      --muted-contrast: #6d7b83;
    }

    /* Responsive base font sizing */
    html {
      font-size: clamp(14px, 1.25vw, 16px);
      -webkit-text-size-adjust:100%;
    }
    body{
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft Yahei", sans-serif;
      margin:0;
      background:var(--bg);
      color:#222;
      line-height:1.45;
      padding-bottom: calc(var(--footer-height) + 18px);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page { display:flex; justify-content:center; padding:20px; gap:20px; box-sizing:border-box; min-height:100vh; }
    .app { width:100%; max-width:var(--content-max); display:grid; grid-template-columns: var(--sidebar-w) 1fr; gap:20px; align-items:start; }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg,#1e3c72,#2a5298);
      color:#fff;
      padding:14px;
      border-radius:10px;
      position:sticky;
      top:20px;
      height:fit-content;
      z-index:20;
      box-shadow: var(--shadow-soft);
      transition: transform .28s ease, opacity .2s ease;
    }
    .logo { text-align:center; font-weight:800; font-size:1.05rem; margin-bottom:10px; letter-spacing:0.4px; }
    .nav { display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .nav a {
      color:rgba(255,255,255,0.97);
      text-decoration:none;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
      display:block;
      font-size:0.98rem;
      box-sizing:border-box;
    }
    .nav a.active, .nav a:hover { background: rgba(255,255,255,0.07); }

    /* Main column */
    .main { display:flex; flex-direction:column; gap:14px; z-index:1; }

    .dashboard-header {
      background:var(--card);
      padding:var(--panel-padding);
      border-radius:var(--radius);
      box-shadow: var(--shadow-strong);
      margin-bottom: 0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .dashboard-header .title-row { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .dashboard-header h1 { margin:0; font-size:clamp(1.05rem, 1.8vw, 1.4rem); color:#172334; font-weight:800; }
    .dashboard-stats { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    .stat-card { background: linear-gradient(180deg,#f7fbff,#ffffff); border-radius:8px; padding:12px 18px; text-align:center; min-width:140px; flex:0 0 auto; box-shadow: var(--shadow-soft); }
    .stat-number { display:block; font-size:1.6rem; font-weight:800; color:var(--primary); line-height:1; }
    .stat-label { font-size:0.95rem; color:var(--muted-contrast); margin-top:6px; }

    .panel { background:var(--card); padding:var(--panel-padding); border-radius:var(--radius); box-shadow:var(--shadow-soft); margin-bottom:8px; }
    .panel .panel-head { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .panel h2 { margin:0; font-size:1rem; color:#243444; font-weight:700; }

    .table-wrap { overflow:auto; border-radius:8px; }
    table.data-table { width:100%; border-collapse:collapse; min-width:680px; font-size:0.96rem; }
    table.data-table th, table.data-table td { padding:12px 14px; border:1px solid #e9eef5; text-align:left; vertical-align:middle; }
    table.data-table th { background:#f7fbff; color:#22303f; font-weight:700; font-size:0.95rem; position:sticky; top:0; z-index:1; }

    .form { display:grid; gap:12px; }
    .form-row { display:flex; flex-direction:column; gap:6px; }
    label { font-weight:700; color:#2c3e50; font-size:0.96rem; }

    input[type="text"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
      padding:10px 12px; border-radius:10px; border:1px solid #d7e0ea; background:#fff; font-size:var(--control-font-size); box-sizing:border-box; height:var(--input-height);
    }
    select.uniform { height:var(--input-height); }
    textarea.uniform { resize:vertical; padding-top:10px; padding-bottom:10px; min-height:var(--input-height); height:calc(var(--input-height) * 1.2); }

    /* Unified controls */
    .uniform { font-size:var(--control-font-size); }

    /* Consumption layout */
    .consumption-grid {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      align-items:start;
    }
    .consumption-left { display:flex; flex-direction:column; gap:10px; }
    .consumption-right { display:flex; flex-direction:column; gap:10px; justify-content:flex-end; }

    /* Make inputs full width within their containers */
    .consumption-grid .uniform { width:100%; box-sizing:border-box; }

    .checkbox-group { display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding-top:6px; font-size:0.95rem; }

    /* Buttons */
    .btn { border:0; padding:10px 14px; border-radius:10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:700; font-size:0.95rem; line-height:1; }
    .btn-primary { background:var(--primary); color:#fff; box-shadow: 0 6px 18px rgba(43,123,211,0.18); }
    .btn-secondary { background:#95a5a6; color:#fff; }
    .btn-success { background:var(--success); color:#fff; }
    .btn-danger { background:var(--danger); color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #e6eef7; color:#22303f; }

    .modal-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; padding:12px; }
    .modal-overlay.show { display:flex; }
    .modal { width:100%; max-width:820px; background:var(--card); border-radius:12px; overflow:auto; max-height:86vh; box-shadow:0 30px 80px rgba(11,32,68,0.18); }
    .modal .modal-head { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #eef4fb; }
    .modal .modal-body { padding:16px; }
    .modal .modal-foot { padding:12px 16px; border-top:1px solid #eef4fb; display:flex; gap:8px; justify-content:flex-end }

    .pagination { display:flex; align-items:center; justify-content:space-between; gap:8px; padding-top:10px; }
    .pagination .page-info { text-align:center; flex:1; color:var(--muted); font-size:0.95rem; }

    footer.app-footer {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      height:var(--footer-height);
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
      border-top:1px solid rgba(0,0,0,0.06);
      font-size:0.95rem;
      color:var(--muted);
      z-index:50;
      padding:0 12px;
    }
    footer.app-footer a { color:var(--primary); text-decoration:none; margin:0 8px; }

    .content-section.hidden { display:none; }

    /* Focus / accessibility */
    a:focus, button:focus, input:focus, select:focus, textarea:focus { outline:3px solid rgba(43,123,211,0.18); outline-offset:2px; }

    /* Small screens: sidebar becomes top bar */
    @media (max-width:960px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position:relative; top:0; margin-bottom:6px; display:flex; flex-direction:row; align-items:center; gap:12px; padding:10px; border-radius:10px; }
      .logo { text-align:left; font-size:1rem; margin-bottom:0; }
      .nav { flex-direction:row; gap:8px; overflow:auto; }
      .nav a { padding:8px 10px; white-space:nowrap; font-weight:700; font-size:0.92rem; border-radius:8px; }
      .consumption-grid { grid-template-columns: 1fr; }
      .consumption-right { flex-direction:column; align-items:stretch; }
      table.data-table { min-width:520px; font-size:0.95rem; }
      .panel { padding:12px; }
      .stat-card { min-width:120px; padding:10px 14px; }
    }

    @media (max-width:520px) {
      html { font-size:14px; }
      table.data-table { min-width:460px; font-size:0.92rem; }
      footer.app-footer { height:56px; font-size:0.9rem; }
      .btn { padding:9px 12px; font-size:0.92rem; }
      :root { --input-height:44px; --control-font-size:14px; }
    }

    /* very large screens: slightly scale up components */
    @media (min-width:1400px) {
      :root { --panel-padding:1.5rem; --input-height:52px; --control-font-size:16px; }
    }

    /* compact table cells for better alignment */
    table.data-table td .td-compact { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="page">
    <div class="app" role="application" aria-label="学员消课管理">
      <aside class="sidebar" aria-label="侧边导航">
        <div class="logo">元一书画</div>
        <nav class="nav" aria-label="主要导航">
          <a href="#students" data-section="students" class="nav-link active">学生管理</a>
          <a href="#course-packages" data-section="course-packages" class="nav-link">课程包管理</a>
          <a href="#consumption" data-section="consumption" class="nav-link">消课管理</a>
          <a href="#records" data-section="records" class="nav-link">消课记录</a>
        </nav>
      </aside>

      <main class="main" id="main">
        <header class="dashboard-header" role="banner">
          <div class="title-row">
            <h1>学员消课管理系统</h1>
            <div class="dashboard-stats" aria-hidden="true">
              <div class="stat-card" title="总学生数">
                <span class="stat-number" id="stat-students">0</span>
                <span class="stat-label">总学生数</span>
              </div>
              <div class="stat-card" title="总课程包">
                <span class="stat-number" id="stat-packages">0</span>
                <span class="stat-label">总课程包</span>
              </div>
            </div>
          </div>
        </header>

        <!-- Students -->
        <section id="students" class="panel content-section" aria-labelledby="students-heading">
          <div class="panel-head">
            <h2 id="students-heading">学生管理</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="student-filter-input" type="text" placeholder="按姓名或课程包筛选学生" style="min-width:200px" />
              <button id="clear-student-filter" class="btn btn-secondary" type="button">清除</button>
              <label style="display:flex;align-items:center;gap:6px">每页
                <select id="students-per-page" style="margin-left:6px"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
              </label>
              <button id="open-add-student-modal" class="btn btn-primary" type="button">＋ 添加学生</button>
            </div>
          </div>

          <div class="table-wrap" role="region" aria-label="学生列表">
            <table class="data-table" aria-describedby="students-heading">
              <thead><tr><th>姓名</th><th>小名</th><th>家长电话</th><th>包数</th><th>包详情</th><th>操作</th></tr></thead>
              <tbody id="student-tbody"></tbody>
            </table>
          </div>
          <div class="pagination" id="students-pagination" aria-hidden="true"></div>
        </section>

        <!-- Course packages -->
        <section id="course-packages" class="panel content-section hidden" aria-labelledby="packages-heading">
          <div class="panel-head">
            <h2 id="packages-heading">预设课程包管理</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:6px">每页
                <select id="packages-per-page" style="margin-left:6px"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
              </label>
              <button id="open-add-package-modal" class="btn btn-primary" type="button">添加预设课程包</button>
            </div>
          </div>

          <div class="table-wrap" role="region" aria-label="课程包列表">
            <table class="data-table" aria-describedby="packages-heading">
              <thead><tr><th>课程类型</th><th>总课时</th><th>来源</th><th>操作</th></tr></thead>
              <tbody id="package-tbody"></tbody>
            </table>
          </div>
          <div class="pagination" id="packages-pagination" aria-hidden="true"></div>
        </section>

        <!-- Consumption -->
        <section id="consumption" class="panel content-section hidden" aria-labelledby="consumption-heading">
          <div class="panel-head">
            <h2 id="consumption-heading">消课管理</h2>
            <div style="display:flex;flex-direction:column;align-items:flex-end">
              <button id="open-activity-rules" class="btn btn-secondary" type="button">设置活动规则</button>
            </div>
          </div>

          <form id="bulk-consume-form" class="form" aria-label="批量消课表单">
            <div class="consumption-grid">
              <div class="consumption-left">
                <div class="form-row">
                  <label for="consume-date">上课日期</label>
                  <input id="consume-date" type="date" class="uniform" />
                </div>

                <div class="form-row">
                  <label for="consume-course-type">课程类型</label>
                  <select id="consume-course-type" class="uniform"><option value="">请选择</option></select>
                </div>

                <div class="form-row">
                  <label for="consume-activity-name">活动名称</label>
                  <select id="consume-activity-name" class="uniform" disabled><option value="">请选择课程后可选活动</option></select>
                </div>
              </div>

              <div class="consumption-right">
                <div class="form-row" style="width:100%">
                  <label for="consume-hours">消耗课时数</label>
                  <input id="consume-hours" type="number" min="0" step="0.1" value="1" class="uniform" />
                </div>
                <div class="form-row" style="width:100%">
                  <label for="consume-note">备注（可选）</label>
                  <textarea id="consume-note" class="uniform" placeholder="填写本次消课备注"></textarea>
                </div>
                <div id="computed-note" style="display:none;color:var(--muted-contrast);font-size:0.95rem;margin-top:6px"></div>
              </div>
            </div>

            <div style="margin-top:12px">
              <label>选择学生（仅在选择课程后显示，显示该课程剩余课时）</label>
              <div id="student-checkboxes" class="checkbox-group" aria-live="polite">请选择课程类型以显示学生</div>
            </div>

            <div style="display:flex;justify-content:flex-end;margin-top:12px">
              <button type="submit" class="btn btn-success">执行消课</button>
            </div>
          </form>
        </section>

        <!-- Records -->
        <section id="records" class="panel content-section hidden" aria-labelledby="records-heading">
          <div class="panel-head">
            <h2 id="records-heading">消课记录</h2>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="record-filter-input" type="text" placeholder="按学生姓名筛选（支持模糊）" />
              <button id="clear-record-filter" class="btn btn-secondary" type="button">清除</button>
              <label style="display:flex;align-items:center;gap:6px">每页
                <select id="records-per-page" style="margin-left:6px"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
              </label>
            </div>
          </div>

          <div class="table-wrap" role="region" aria-label="消课记录表">
            <table class="data-table" aria-describedby="records-heading">
              <thead><tr><th>日期</th><th>学生姓名</th><th>课程类型</th><th>消耗课时</th><th>剩余课时</th><th>备注</th><th>操作</th></tr></thead>
              <tbody id="record-tbody"></tbody>
            </table>
          </div>
          <div class="pagination" id="records-pagination" aria-hidden="true"></div>
        </section>

      </main>
    </div>
  </div>

  <!-- Generic modal (will be filled by JS) -->
  <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-head">
        <h3 id="modal-title">模态</h3>
        <div><button id="close-modal" class="btn btn-ghost" type="button">关闭</button></div>
      </div>
      <div class="modal-body">
        <div id="modal-forms-container"></div>
      </div>
      <div class="modal-foot">
        <button id="save-item" class="btn btn-primary" type="button">保存</button>
        <button id="cancel-item" class="btn btn-secondary" type="button">取消</button>
      </div>
    </div>
  </div>

  <div id="confirm-delete-dialog" class="modal-overlay" aria-hidden="true" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head"><h3>确认删除</h3><div><button id="close-confirm" class="btn btn-ghost" type="button">关闭</button></div></div>
      <div class="modal-body"><p id="confirm-message">确定要删除？</p></div>
      <div class="modal-foot"><button id="confirm-delete" class="btn btn-danger" type="button">确定</button><button id="cancel-delete" class="btn btn-secondary" type="button">取消</button></div>
    </div>
  </div>

  <footer class="app-footer" role="contentinfo" aria-label="页脚">
    雁归南研究所出品
    <span style="margin-left:8px;">
      <a href="https://xhslink.com/m/AJ7M5Ordlu0" target="_blank" rel="noopener noreferrer">小红书</a>
      <span style="margin:0 8px;color:var(--muted)">|</span>
      <a href="https://afdian.com/a/Rashida" target="_blank" rel="noopener noreferrer">爱发电</a>
    </span>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Data
    let students = JSON.parse(localStorage.getItem('students')) || [];
    let packages = JSON.parse(localStorage.getItem('packages')) || [];
    let records = JSON.parse(localStorage.getItem('records')) || [];
    let activityRules = JSON.parse(localStorage.getItem('activityRules')) || [];

    // small state
    let lastManualConsumeHours = NaN;

    // DOM refs
    const navLinks = document.querySelectorAll('.nav-link');
    const sectionMap = {
      'students': document.getElementById('students'),
      'course-packages': document.getElementById('course-packages'),
      'consumption': document.getElementById('consumption'),
      'records': document.getElementById('records')
    };
    const statStudents = document.getElementById('stat-students');
    const statPackages = document.getElementById('stat-packages');

    const studentTbody = document.getElementById('student-tbody');
    const packageTbody = document.getElementById('package-tbody');
    const recordTbody = document.getElementById('record-tbody');

    const modalOverlay = document.getElementById('modal-overlay');
    const closeModalBtn = document.getElementById('close-modal');
    const cancelItemBtn = document.getElementById('cancel-item');
    const saveItemBtn = document.getElementById('save-item');
    const modalFormsContainer = document.getElementById('modal-forms-container');

    const consumeDateInput = document.getElementById('consume-date');
    const consumeCourseTypeSelect = document.getElementById('consume-course-type');
    const consumeActivityNameSelect = document.getElementById('consume-activity-name');
    const consumeHoursInput = document.getElementById('consume-hours');
    const consumeNoteInput = document.getElementById('consume-note');
    const studentCheckboxesDiv = document.getElementById('student-checkboxes');
    const computedNoteEl = document.getElementById('computed-note');

    const recordFilterInput = document.getElementById('record-filter-input');
    const clearRecordFilterBtn = document.getElementById('clear-record-filter');

    const studentFilterInput = document.getElementById('student-filter-input');
    const clearStudentFilterBtn = document.getElementById('clear-student-filter');

    // Utilities
    const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    function saveAllLocal() {
      localStorage.setItem('students', JSON.stringify(students));
      localStorage.setItem('packages', JSON.stringify(packages));
      localStorage.setItem('records', JSON.stringify(records));
      localStorage.setItem('activityRules', JSON.stringify(activityRules));
      refreshAll();
    }

    // Renderers
    function refreshAll() {
      statStudents.textContent = students.length;
      statPackages.textContent = packages.length;
      renderCourseTypeOptions();
      renderActivityNameOptions(consumeCourseTypeSelect.value);
      renderStudents();
      renderPackages();
      renderRecords();
      renderStudentCheckboxesForCourse(consumeCourseTypeSelect.value);
    }

    function renderStudents() {
      studentTbody.innerHTML = '';
      if (!students.length) { studentTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;padding:16px">暂无学生</td></tr>'; return; }
      students.forEach(s => {
        const pkgDetails = (s.packages || []).map(p => `${escapeHtml(p.type)} (${p.remainingHours == null ? p.totalHours : p.remainingHours}课时)`).join('；') || '-';
        const tr = document.createElement('tr'); tr.dataset.id = s.id;
        tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.nickname||'-')}</td><td>${escapeHtml(s.phone||'-')}</td><td>${(s.packages||[]).length}</td><td>${pkgDetails}</td>
          <td><div class="td-compact"><button class="btn btn-secondary edit-student">编辑</button> <button class="btn btn-danger delete-student">删除</button></div></td>`;
        studentTbody.appendChild(tr);
      });
    }

    function renderPackages() {
      packageTbody.innerHTML = '';
      if (!packages.length) { packageTbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;padding:16px">暂无课程包</td></tr>'; return; }
      packages.forEach(p => {
        const tr = document.createElement('tr'); tr.dataset.id = p.id;
        tr.innerHTML = `<td>${escapeHtml(p.type)}</td><td>${p.totalHours}</td><td>${escapeHtml(p.source||'-')}</td>
          <td><div class="td-compact"><button class="btn btn-primary btn-assign">分配</button> <button class="btn btn-secondary edit-package">编辑</button> <button class="btn btn-danger delete-package">删除</button></div></td>`;
        packageTbody.appendChild(tr);
      });
    }

    function renderRecords() {
      recordTbody.innerHTML = '';
      if (!records.length) { recordTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;padding:16px">暂无记录</td></tr>'; return; }
      records.forEach(r => {
        const tr = document.createElement('tr'); tr.dataset.id = r.id;
        tr.innerHTML = `<td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.studentName)}</td><td>${escapeHtml(r.courseType)}</td><td>${Number(r.consumedHours).toFixed(2)}</td><td>${Number(r.remainingHours).toFixed(2)}</td><td>${escapeHtml(r.note||'-')}</td><td><button class="btn btn-secondary undo-record" data-id="${r.id}">撤销</button></td>`;
        recordTbody.appendChild(tr);
      });
    }

    function renderStudentCheckboxesForCourse(courseType) {
      studentCheckboxesDiv.innerHTML = '';
      if (!courseType) { studentCheckboxesDiv.textContent = '请选择课程类型以显示学生'; return; }
      const matched = students.filter(st => (st.packages || []).some(p => (p.type || '').trim() === courseType));
      if (!matched.length) { studentCheckboxesDiv.innerHTML = '<div style="color:#666">没有分配过该课程包的学生</div>'; return; }
      matched.forEach(st => {
        const packs = (st.packages || []).filter(p => (p.type || '').trim() === courseType);
        const totalRemaining = packs.reduce((acc, p) => acc + ((p.remainingHours == null) ? p.totalHours : p.remainingHours), 0);
        const label = document.createElement('label');
        label.style.cursor = 'pointer';
        label.innerHTML = `<input type="checkbox" data-student-id="${st.id}" style="margin-right:8px" /> ${escapeHtml(st.name)} （剩余：${Number(totalRemaining).toFixed(2)}）`;
        studentCheckboxesDiv.appendChild(label);
      });
    }

    function renderCourseTypeOptions() {
      const types = [...new Set(packages.map(p => (p.type || '').trim()).filter(Boolean))];
      consumeCourseTypeSelect.innerHTML = '<option value="">请选择</option>';
      types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; consumeCourseTypeSelect.appendChild(o); });
    }

    function renderActivityNameOptions(filterCourseType) {
      const names = activityRules.filter(r => !filterCourseType || r.courseType === filterCourseType).map(r => r.activityName);
      const uniq = [...new Set(names)].filter(Boolean);
      consumeActivityNameSelect.innerHTML = '';
      if (!filterCourseType) {
        const o = document.createElement('option'); o.value=''; o.textContent='请选择课程后可选活动'; o.disabled=true; o.selected=true; consumeActivityNameSelect.appendChild(o); consumeActivityNameSelect.disabled=true; return;
      }
      if (!uniq.length) {
        const o = document.createElement('option'); o.value=''; o.textContent='当前课程暂无特殊活动'; o.disabled=true; o.selected=true; consumeActivityNameSelect.appendChild(o); consumeActivityNameSelect.disabled=true; return;
      }
      const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='无特殊活动（默认手动输入）'; placeholder.selected=true; consumeActivityNameSelect.appendChild(placeholder);
      uniq.forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; consumeActivityNameSelect.appendChild(o); });
      consumeActivityNameSelect.disabled = false;
    }

    function findActivityRule(activityName, courseType) {
      return activityRules.find(r => r.activityName === activityName && r.courseType === courseType);
    }
    function applyActivityComputedHours(activityName, courseType){
      if (!activityName || !courseType) { if (computedNoteEl) computedNoteEl.style.display = 'none'; consumeHoursInput.removeAttribute('readonly'); return; }
      const rule = findActivityRule(activityName, courseType);
      if (!rule) { if (computedNoteEl) computedNoteEl.style.display = 'none'; consumeHoursInput.removeAttribute('readonly'); return; }
      // preserve last manual value
      if (!consumeHoursInput.hasAttribute('readonly')) {
        const v = parseFloat(consumeHoursInput.value); if (!isNaN(v) && v > 0) lastManualConsumeHours = v;
      }
      const per = parseFloat(rule.perSession);
      consumeHoursInput.value = per;
      consumeHoursInput.setAttribute('readonly','true');
      if (computedNoteEl) {
        computedNoteEl.style.display = 'block';
        computedNoteEl.textContent = `活动规则：${rule.activityName} — ${rule.days}天 / ${rule.totalHours}课时；每次应扣 ${per.toFixed(2)} 课时（系统自动应用）`;
      }
    }

    // Navigation
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        const target = link.dataset.section;
        Object.keys(sectionMap).forEach(k => {
          const el = sectionMap[k];
          if (!el) return;
          if (k === target) el.classList.remove('hidden'); else el.classList.add('hidden');
        });
        // smaller render refreshes
        if (target === 'students') renderStudents();
        if (target === 'course-packages') renderPackages();
        if (target === 'consumption') { renderCourseTypeOptions(); renderActivityNameOptions(consumeCourseTypeSelect.value); renderStudentCheckboxesForCourse(consumeCourseTypeSelect.value); }
        if (target === 'records') renderRecords();

        // On small screens, collapse top nav by blurring focus to improve layout (nice to have)
        if (window.innerWidth <= 960) (document.activeElement||document.body).blur();
      });
    });

    // Modal helpers (generic)
    function openModalWith(html, title) {
      modalFormsContainer.innerHTML = html;
      document.getElementById('modal-title').textContent = title || '模态';
      modalOverlay.classList.add('show'); modalOverlay.style.display = 'flex'; modalOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
    }
    function closeModal() { modalOverlay.classList.remove('show'); modalOverlay.style.display = 'none'; modalOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; modalFormsContainer.innerHTML = ''; }

    closeModalBtn && closeModalBtn.addEventListener('click', closeModal);
    cancelItemBtn && cancelItemBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });

    // Set today's date as default
    (function setTodayDate(){
      const dt = new Date();
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth() + 1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      if (consumeDateInput) consumeDateInput.value = `${yyyy}-${mm}-${dd}`;
    })();

    // Delegated main actions (add/edit/delete/assign/undo/activity)
    document.querySelector('.main').addEventListener('click', (e) => {
      if (e.target.closest('#open-add-student-modal')) {
        openModalWith(`
          <form id="modal-student-form" class="form">
            <div class="form-row"><label>姓名</label><input id="modal-stu-name" class="uniform" /></div>
            <div class="form-row"><label>小名</label><input id="modal-stu-nick" class="uniform" /></div>
            <div class="form-row"><label>家长电话</label><input id="modal-stu-phone" class="uniform" /></div>
          </form>`, '添加学生');
        saveItemBtn.onclick = () => {
          const name = document.getElementById('modal-stu-name').value.trim();
          const nick = document.getElementById('modal-stu-nick').value.trim();
          const phone = document.getElementById('modal-stu-phone').value.trim();
          if (!name || !phone) { alert('请���写姓名与电话'); return; }
          const nid = Math.max(0, ...students.map(s=>s.id)) + 1;
          students.push({ id: nid, name, nickname: nick, phone, packages: [] });
          saveAllLocal(); closeModal();
        };
        return;
      }

      if (e.target.closest('.edit-student')) {
        const row = e.target.closest('tr'); const id = parseInt(row.dataset.id,10); const st = students.find(s=>s.id===id); if(!st) return;
        openModalWith(`
          <form id="modal-student-form" class="form">
            <div class="form-row"><label>姓名</label><input id="modal-stu-name" class="uniform" value="${escapeHtml(st.name)}" /></div>
            <div class="form-row"><label>小名</label><input id="modal-stu-nick" class="uniform" value="${escapeHtml(st.nickname||'')}" /></div>
            <div class="form-row"><label>家长电话</label><input id="modal-stu-phone" class="uniform" value="${escapeHtml(st.phone||'')}" /></div>
          </form>`, '编辑学生');
        saveItemBtn.onclick = () => {
          const name = document.getElementById('modal-stu-name').value.trim();
          const nick = document.getElementById('modal-stu-nick').value.trim();
          const phone = document.getElementById('modal-stu-phone').value.trim();
          if (!name || !phone) { alert('请填写姓名与电话'); return; }
          st.name = name; st.nickname = nick; st.phone = phone;
          saveAllLocal(); closeModal();
        };
        return;
      }

      if (e.target.closest('.delete-student')) {
        const row = e.target.closest('tr'); const id = parseInt(row.dataset.id,10);
        document.getElementById('confirm-message').textContent = `确定删除 "${row.cells[0].textContent.trim()}" 吗？（会同时删除该学员的消课记录）`;
        document.getElementById('confirm-delete').onclick = () => {
          students = students.filter(s=>s.id !== id);
          records = records.filter(r=>r.studentId !== id);
          saveAllLocal();
          document.getElementById('confirm-delete').onclick = null;
          document.getElementById('close-confirm').click();
        };
        document.getElementById('confirm-delete').parentElement.parentElement.style.display='block';
        document.getElementById('close-confirm').onclick = () => { document.getElementById('confirm-delete').parentElement.parentElement.style.display='none'; };
        return;
      }

      if (e.target.closest('#open-add-package-modal')) {
        openModalWith(`
          <form id="modal-package-form" class="form">
            <div class="form-row"><label>课程类型</label><input id="modal-pkg-type" class="uniform" /></div>
            <div class="form-row"><label>总课时</label><input id="modal-pkg-hours" type="number" class="uniform" /></div>
            <div class="form-row"><label>来源</label><input id="modal-pkg-source" class="uniform" /></div>
          </form>`, '添加预设课程包');
        saveItemBtn.onclick = () => {
          const type = document.getElementById('modal-pkg-type').value.trim();
          const hours = parseInt(document.getElementById('modal-pkg-hours').value,10);
          const src = document.getElementById('modal-pkg-source').value.trim();
          if (!type || !hours) { alert('请填写课程类型与总课时'); return; }
          const nid = Math.max(0, ...packages.map(p=>p.id)) + 1;
          packages.push({ id: nid, type, totalHours: hours, source: src });
          saveAllLocal(); closeModal();
        };
        return;
      }

      if (e.target.closest('.edit-package')) {
        const row = e.target.closest('tr'); const id = parseInt(row.dataset.id,10); const pkg = packages.find(p=>p.id===id); if(!pkg) return;
        openModalWith(`
          <form id="modal-package-form" class="form">
            <div class="form-row"><label>课程类型</label><input id="modal-pkg-type" class="uniform" value="${escapeHtml(pkg.type)}" /></div>
            <div class="form-row"><label>总课时</label><input id="modal-pkg-hours" type="number" class="uniform" value="${pkg.totalHours}" /></div>
            <div class="form-row"><label>来源</label><input id="modal-pkg-source" class="uniform" value="${escapeHtml(pkg.source||'')}" /></div>
          </form>`, '编辑课程包');
        saveItemBtn.onclick = () => {
          const type = document.getElementById('modal-pkg-type').value.trim();
          const hours = parseInt(document.getElementById('modal-pkg-hours').value,10);
          const src = document.getElementById('modal-pkg-source').value.trim();
          if (!type || !hours) { alert('请填写课程类型与总课时'); return; }
          pkg.type = type; pkg.totalHours = hours; pkg.source = src;
          students.forEach(s => (s.packages||[]).forEach(sp=>{ if(sp.packageId===pkg.id){ sp.type = type; sp.totalHours = hours; if(sp.remainingHours==null) sp.remainingHours = hours; } }));
          saveAllLocal(); closeModal();
        };
        return;
      }

      if (e.target.closest('.delete-package')) {
        const row = e.target.closest('tr'); const id = parseInt(row.dataset.id,10);
        document.getElementById('confirm-message').textContent = `确定删除 "${row.cells[0].textContent.trim()}" 吗？`;
        document.getElementById('confirm-delete').onclick = () => {
          students.forEach(s=> s.packages = (s.packages||[]).filter(p=>p.packageId !== id));
          packages = packages.filter(p=>p.id !== id);
          saveAllLocal();
          document.getElementById('confirm-delete').onclick = null;
          document.getElementById('close-confirm').click();
        };
        document.getElementById('confirm-delete').parentElement.parentElement.style.display='block';
        document.getElementById('close-confirm').onclick = () => { document.getElementById('confirm-delete').parentElement.parentElement.style.display='none'; };
        return;
      }

      if (e.target.closest('.btn-assign')) {
        const row = e.target.closest('tr'); const pkgId = parseInt(row.dataset.id,10);
        // build assign modal
        const html = `<form id="modal-assign-form" class="form"><div class="form-row"><label>选择学生</label><div id="modal-assign-students" class="checkbox-group"></div></div></form>`;
        openModalWith(html, '分配课程包');
        const container = document.getElementById('modal-assign-students');
        container.innerHTML = '';
        students.forEach(s=>{
          const already = (s.packages||[]).some(p=>p.packageId === pkgId);
          const label = document.createElement('label');
          label.style.cursor = 'pointer';
          label.innerHTML = `<input type="checkbox" data-student-id="${s.id}" ${already?'disabled':''}/> ${escapeHtml(s.name)} ${already? '(已分配)':''}`;
          container.appendChild(label);
        });
        saveItemBtn.onclick = () => {
          const checked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'));
          if (!checked.length) { alert('请选择学生'); return; }
          const pkg = packages.find(p=>p.id === pkgId);
          checked.forEach(cb=>{
            const sid = parseInt(cb.dataset.studentId,10); const st = students.find(s=>s.id===sid);
            if (!st) return;
            st.packages = st.packages || [];
            if (!st.packages.some(p=>p.packageId === pkg.id)) st.packages.push({ packageId: pkg.id, type: pkg.type, totalHours: pkg.totalHours, remainingHours: pkg.totalHours });
          });
          saveAllLocal(); closeModal();
        };
        return;
      }

      if (e.target.closest('#open-activity-rules')) {
        // build activity modal form + list
        let html = `<form id="modal-activity-form" class="form">
          <div class="form-row"><label>活动名称</label><input id="modal-act-name" class="uniform" /></div>
          <div class="form-row"><label>课程类型</label><select id="modal-act-course" class="uniform"><option value="">请选择</option></select></div>
          <div class="form-row"><label>活动天数</label><input id="modal-act-days" type="number" class="uniform" value="1" min="1" /></div>
          <div class="form-row"><label>活动总课时</label><input id="modal-act-total" type="number" class="uniform" value="1" min="1" /></div>
        </form>
        <div style="margin-top:12px"><h4>已保存的活动规则</h4><div id="modal-act-list" style="margin-top:8px"></div></div>`;
        openModalWith(html, '活动规则设置');
        // fill courses
        const types = [...new Set(packages.map(p=>p.type).filter(Boolean))];
        const sel = document.getElementById('modal-act-course');
        types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o); });
        // fill rules list
        const list = document.getElementById('modal-act-list');
        list.innerHTML = '';
        if (!activityRules.length) list.innerHTML = '<div style="color:#666">暂无活动规则</div>';
        else activityRules.forEach(r => {
          const div = document.createElement('div'); div.style.padding='8px 0'; div.style.borderBottom='1px solid #eee';
          div.innerHTML = `<strong>${escapeHtml(r.activityName)}</strong> — ${escapeHtml(r.courseType)}：${r.days}天 / ${r.totalHours}课时（每次 ${parseFloat(r.perSession).toFixed(2)}）
            <button class="btn btn-secondary edit-activity" data-id="${r.id}">编辑</button>
            <button class="btn btn-danger delete-activity" data-id="${r.id}">删除</button>`;
          list.appendChild(div);
        });
        saveItemBtn.onclick = () => {
          const name = document.getElementById('modal-act-name').value.trim();
          const course = document.getElementById('modal-act-course').value;
          const days = parseInt(document.getElementById('modal-act-days').value,10);
          const total = parseFloat(document.getElementById('modal-act-total').value);
          if (!name || !course || !days || !total) { alert('请完整填写活动规则'); return; }
          const perSession = total / days;
          const id = `${Date.now()}_${Math.floor(Math.random()*1000)}`;
          activityRules.push({ id, activityName: name, courseType: course, days, totalHours: total, perSession });
          saveAllLocal(); closeModal();
        };
        return;
      }
    });

    // Activity edit/delete handlers delegated
    document.addEventListener('click', (e) => {
      if (e.target.matches('.edit-activity')) {
        const id = e.target.dataset.id;
        const rule = activityRules.find(r=>String(r.id)===String(id));
        if(!rule) return;
        // reopen activity modal with values
        openModalWith(`
          <form id="modal-activity-form" class="form">
            <div class="form-row"><label>活动名称</label><input id="modal-act-name" class="uniform" value="${escapeHtml(rule.activityName)}" /></div>
            <div class="form-row"><label>课程类型</label><select id="modal-act-course" class="uniform"><option value="">请选择</option></select></div>
            <div class="form-row"><label>活动天数</label><input id="modal-act-days" type="number" class="uniform" value="${rule.days}" min="1" /></div>
            <div class="form-row"><label>活动总课时</label><input id="modal-act-total" type="number" class="uniform" value="${rule.totalHours}" min="1" /></div>
          </form>`, '编辑活动规则');
        // fill course types
        const types = [...new Set(packages.map(p=>p.type).filter(Boolean))];
        const sel = document.getElementById('modal-act-course');
        types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o); });
        sel.value = rule.courseType;
        saveItemBtn.onclick = () => {
          const name = document.getElementById('modal-act-name').value.trim();
          const course = document.getElementById('modal-act-course').value;
          const days = parseInt(document.getElementById('modal-act-days').value,10);
          const total = parseFloat(document.getElementById('modal-act-total').value);
          if (!name || !course || !days || !total) { alert('请完整填写活动规则'); return; }
          rule.activityName = name; rule.courseType = course; rule.days = days; rule.totalHours = total; rule.perSession = total / days;
          saveAllLocal(); closeModal();
        };
      }

      if (e.target.matches('.delete-activity')) {
        const id = e.target.dataset.id;
        activityRules = activityRules.filter(r => String(r.id) !== String(id));
        saveAllLocal();
        alert('已删除活动规则');
      }
    });

    // Bulk consume submit
    document.getElementById('bulk-consume-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const date = (consumeDateInput.value||'').trim();
      const courseType = consumeCourseTypeSelect.value;
      let manualHours = parseFloat(consumeHoursInput.value);
      const note = consumeNoteInput.value || '';
      const checked = studentCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked');
      const activityName = consumeActivityNameSelect.value;
      if (!date || !courseType) { alert('请选择日期与课程类型'); return; }
      if (!checked.length) { alert('请选择至少一名学生'); return; }
      let perSession = manualHours;
      if (consumeActivityNameSelect && !consumeActivityNameSelect.disabled && activityName) {
        const rule = findActivityRule(activityName, courseType); if (rule) perSession = parseFloat(rule.perSession);
      }
      if (!perSession || isNaN(perSession) || perSession <= 0) { alert('无效的消耗课时数'); return; }
      const ids = Array.from(checked).map(cb => parseInt(cb.dataset.studentId, 10));
      ids.forEach(id => {
        const st = students.find(s=>s.id===id); if (!st) return;
        let usedPkgId = null, remainingAfter = 0;
        if (consumeActivityNameSelect && !consumeActivityNameSelect.disabled && activityName) {
          const spAct = (st.packages||[]).find(p=>p.isActivity && p.activityName===activityName && p.type===courseType && (p.remainingHours || p.totalHours) > 0);
          if (spAct) { spAct.remainingHours = Math.max(0, (spAct.remainingHours==null?spAct.totalHours:spAct.remainingHours) - perSession); usedPkgId = spAct.packageId; remainingAfter = spAct.remainingHours; }
          else {
            const spReg = (st.packages||[]).find(p=>!p.isActivity && p.type===courseType && (p.remainingHours || p.totalHours) > 0);
            if (spReg) { spReg.remainingHours = Math.max(0, (spReg.remainingHours==null?spReg.totalHours:spReg.remainingHours) - perSession); usedPkgId = spReg.packageId; remainingAfter = spReg.remainingHours; }
            else remainingAfter = 0;
          }
        } else {
          const sp = (st.packages||[]).find(p=>p.type===courseType && (p.remainingHours || p.totalHours) > 0);
          if (sp) { sp.remainingHours = Math.max(0, (sp.remainingHours==null?sp.totalHours:sp.remainingHours) - perSession); usedPkgId = sp.packageId; remainingAfter = sp.remainingHours; }
          else remainingAfter = 0;
        }
        const recId = `${Date.now()}_${Math.floor(Math.random()*1000)}`;
        records.push({ id: recId, date, studentId: id, studentName: st.name, courseType, consumedHours: perSession, remainingHours: remainingAfter, packageId: usedPkgId, activityName: (consumeActivityNameSelect && !consumeActivityNameSelect.disabled && activityName) ? activityName : null, note });
      });
      saveAllLocal();
      alert(`${ids.length} 名学生已扣除课时（每次 ${perSession.toFixed(2)}）`);
      document.getElementById('bulk-consume-form').reset();
      // reset date to today after reset
      (function setToday(){ const dt = new Date(); const yyyy = dt.getFullYear(); const mm = String(dt.getMonth()+1).padStart(2,'0'); const dd = String(dt.getDate()).padStart(2,'0'); consumeDateInput.value = `${yyyy}-${mm}-${dd}`; })();
      if (computedNoteEl) computedNoteEl.style.display = 'none';
    });

    // Select change handlers
    consumeCourseTypeSelect && consumeCourseTypeSelect.addEventListener('change', (e) => {
      const ct = e.target.value; renderActivityNameOptions(ct); renderStudentCheckboxesForCourse(ct);
      if (!consumeActivityNameSelect.disabled && consumeActivityNameSelect.value) applyActivityComputedHours(consumeActivityNameSelect.value, ct);
      else { consumeHoursInput.removeAttribute('readonly'); if (!isNaN(lastManualConsumeHours) && lastManualConsumeHours > 0) consumeHoursInput.value = lastManualConsumeHours; else consumeHoursInput.value = 1; if (computedNoteEl) computedNoteEl.style.display = 'none'; }
    });
    consumeActivityNameSelect && consumeActivityNameSelect.addEventListener('change', (e) => {
      const act = e.target.value; const ct = consumeCourseTypeSelect.value;
      if (act) applyActivityComputedHours(act, ct);
      else { consumeHoursInput.removeAttribute('readonly'); if (!isNaN(lastManualConsumeHours) && lastManualConsumeHours > 0) consumeHoursInput.value = lastManualConsumeHours; else consumeHoursInput.value = 1; if (computedNoteEl) computedNoteEl.style.display = 'none'; }
    });

    // Undo / record actions (delegated)
    document.addEventListener('click', (e) => {
      if (e.target.matches('.undo-record')) {
        const id = e.target.dataset.id;
        const idx = records.findIndex(r => String(r.id) === String(id));
        if (idx === -1) return;
        const rec = records[idx];
        // restore hours if package found
        if (rec.packageId) {
          const st = students.find(s => s.id === rec.studentId);
          if (st) {
            const pkg = (st.packages||[]).find(p => p.packageId === rec.packageId);
            if (pkg) pkg.remainingHours = Number(pkg.remainingHours || pkg.totalHours) + Number(rec.consumedHours || 0);
          }
        }
        records.splice(idx,1);
        saveAllLocal();
        alert('已撤销该记录并恢复课时');
      }
    });

    // Initial render + default view
    (function init(){
      refreshAll();
      Object.keys(sectionMap).forEach(k=>sectionMap[k].classList.add('hidden'));
      sectionMap['students'].classList.remove('hidden');
      navLinks.forEach(l=>l.classList.remove('active'));
      document.querySelector('.nav-link[data-section="students"]').classList.add('active');
      // set today's date
      const dt = new Date(); const yyyy = dt.getFullYear(); const mm = String(dt.getMonth()+1).padStart(2,'0'); const dd = String(dt.getDate()).padStart(2,'0');
      if (consumeDateInput) consumeDateInput.value = `${yyyy}-${mm}-${dd}`;
    })();
  });
  </script>
</body>
</html>