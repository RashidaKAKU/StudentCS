<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学员消课管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
        }

        .tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab:hover {
            background-color: #ecf0f1;
        }

        .tab.active:hover {
            background-color: #2980b9;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            flex: 0 0 250px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-actions button {
            padding: 4px 8px;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* 为操作列设置固定宽度，避免按钮错位 */
        th:last-child, td:last-child {
            min-width: 150px;
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .filter-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .pagination-info {
            font-size: 14px;
            color: #555;
            margin: 0 10px;
        }
        
        .pagination select {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            color: #333;
            width: 70px;
            margin-left: 5px;
        }
        
        .pagination span {
            font-size: 14px;
            color: #555;
        }
        
        /* 基础样式优化 */
        .stats {
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
        }
        
        /* 响应式设计 - 针对手机等小屏幕设备 */
        @media (max-width: 768px) {
            /* 调整容器宽度 */
            .container {
                padding: 10px;
            }
            
            /* 优化标签栏样式 */
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 50%; /* 每行显示2个标签 */
                padding: 10px;
                font-size: 14px;
            }
            
            /* 优化统计卡片布局 */
            .stats {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stat-card {
                width: 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            /* 优化筛选框布局 */
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group .form-group {
                margin-bottom: 10px;
            }
            
            /* 优化按钮组布局 */
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            
            /* 优化表单行布局 */
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            /* 优化表格显示 */
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
            
            /* 优化分页控件 */
            .pagination {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .pagination-info {
                margin: 0 10px;
            }
            
            /* 优化模态框样式 */
            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
        }
        
        /* 针对非常小的屏幕设备 */
        @media (max-width: 480px) {
            /* 调整标签栏 */
            .tab {
                flex: 1 0 100%; /* 每行显示1个标签 */
            }
            
            /* 简化表格显示 */
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            /* 隐藏部分非关键列 */
            th:nth-child(3), td:nth-child(3), /* 小名 */
            th:nth-child(4), td:nth-child(4) /* 家长联系方式 */
            {
                display: none;
            }
            
            /* 进一步优化分页控件 */
            .pagination {
                justify-content: center;
                align-items: center;
            }
            
            .pagination button {
                width: 100px;
            }
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input {
            width: auto;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>学员消课管理系统</h1>
        
        <div class="stats" id="stats">
            <!-- 统计数据将通过JS动态填充 -->
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="students">学生管理</button>
            <button class="tab" data-tab="course-packages">课程包管理</button>
            <button class="tab" data-tab="activity-rules">活动规则</button>
            <button class="tab" data-tab="consume">消课管理</button>
            <button class="tab" data-tab="records">消课记录</button>
        </div>

        <!-- 学生管理 -->
        <div class="tab-content active" id="students">
            <h2>学生管理</h2>
            
            <div class="filter-group">
                <div class="form-group">
                    <input type="text" id="student-name-filter" placeholder="输入学生姓名">
                </div>
                <div class="form-group">
                    <select id="student-course-type-filter">
                        <option value="">所有课程类型</option>
                        <!-- 课程类型将通过JS动态填充 -->
                    </select>
                </div>
                <button class="btn-primary" onclick="filterStudents()">筛选</button>
                <button class="btn-secondary" onclick="resetStudentFilter()">重置</button>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="openAddStudentModal()">添加学生</button>
                <button class="btn-success" onclick="openAssignCoursePackageModal()">分配课程包</button>
            </div>

            <table id="students-table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>昵称</th>
                        <th>联系方式</th>
                        <th>课程包信息</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 学生数据将通过JS动态填充 -->
                </tbody>
            </table>
            
            <div class="pagination" id="students-pagination">
                <!-- 分页控件将通过JS动态填充 -->
            </div>
        </div>

        <!-- 课程包管理 -->
        <div class="tab-content" id="course-packages">
            <h2>课程包管理</h2>
            
            <div class="button-group">
                <button class="btn-primary" onclick="openAddCoursePackageModal()">添加课程包</button>
            </div>

            <table id="course-packages-table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>总课时</th>
                        <th>课程类型</th>
                        <th>价格</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 课程包数据将通过JS动态填充 -->
                </tbody>
            </table>
            
            <div class="pagination" id="course-packages-pagination">
                <!-- 分页控件将通过JS动态填充 -->
            </div>
        </div>

        <!-- 活动规则管理 -->
        <div class="tab-content" id="activity-rules">
            <h2>活动规则管理</h2>
            
            <div class="button-group">
                <button class="btn-primary" onclick="openAddActivityRuleModal()">添加活动规则</button>
            </div>

            <table id="activity-rules-table">
                <thead>
                    <tr>
                        <th>活动名称</th>
                        <th>课程类型</th>
                        <th>天数</th>
                        <th>总课时</th>
                        <th>每节课课时</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 活动规则数据将通过JS动态填充 -->
                </tbody>
            </table>
        </div>

        <!-- 消课管理 -->
        <div class="tab-content" id="consume">
            <h2>消课管理</h2>
            
            <div class="form-group">
                    <label for="consume-course-type">课程类型</label>
                    <select id="consume-course-type" onchange="loadStudentsByCourseType()">
                        <option value="">选择课程类型</option>
                        <!-- 课程类型将通过JS动态填充 -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="consume-students">选择学生</label>
                    <div id="consume-students" class="checkbox-group">
                        <!-- 学生列表将通过JS动态填充 -->
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="consume-activity">活动</label>
                        <select id="consume-activity" onchange="updateConsumeHours()" disabled>
                            <option value="">选择活动</option>
                            <!-- 活动将通过JS动态填充 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consume-hours">消耗课时</label>
                        <input type="number" id="consume-hours" step="0.5" placeholder="自动计算或手动输入">
                    </div>
                </div>

                <div class="form-group">
                    <label for="consume-date">消课时间</label>
                    <input type="date" id="consume-date">
                </div>

                <div class="form-group">
                    <label for="consume-remark">备注</label>
                    <textarea id="consume-remark" rows="3"></textarea>
                </div>

                <button class="btn-success" onclick="consumeHours()">批量消课</button>
        </div>

        <!-- 消课记录 -->
        <div class="tab-content" id="records">
            <h2>消课记录</h2>
            
            <div class="filter-group">
                <div class="form-group">
                    <input type="text" id="record-student-name" placeholder="输入学生姓名">
                </div>
                <div class="form-group">
                    <select id="record-course-package-filter">
                        <option value="">所有课程包</option>
                        <!-- 课程包将通过JS动态填充 -->
                    </select>
                </div>
                <button class="btn-primary" onclick="filterRecords()">筛选</button>
                <button class="btn-secondary" onclick="resetRecordFilter()">重置</button>
            </div>

            <table id="records-table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>课程包</th>
                        <th>活动</th>
                        <th>消耗课时</th>
                        <th>消课时间</th>
                        <th>备注</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 消课记录将通过JS动态填充 -->
                </tbody>
            </table>
            
            <div class="pagination" id="records-pagination">
                <!-- 分页控件将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- 添加学生模态框 -->
    <div id="add-student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加学生</h3>
                <span class="close" onclick="closeAddStudentModal()">&times;</span>
            </div>
            <form id="add-student-form">
                <div class="form-group">
                    <label for="student-name">姓名 <span style="color: red;">*</span></label>
                    <input type="text" id="student-name" required placeholder="请输入学生姓名">
                </div>
                <div class="form-group">
                    <label for="student-nickname">昵称</label>
                    <input type="text" id="student-nickname" placeholder="请输入学生昵称（选填）">
                </div>
                <div class="form-group">
                    <label for="student-parent-contact">联系方式</label>
                    <input type="text" id="student-parent-contact" placeholder="请输入联系方式（选填）">
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeAddStudentModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加课程包模态框 -->
    <div id="add-course-package-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加课程包</h3>
                <span class="close" onclick="closeAddCoursePackageModal()">&times;</span>
            </div>
            <form id="add-course-package-form">
                <div class="form-group">
                    <label for="package-name">名称</label>
                    <input type="text" id="package-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="package-total-hours">总课时</label>
                        <input type="number" id="package-total-hours" required>
                    </div>
                    <div class="form-group">
                        <label for="package-course-type">课程类型</label>
                        <input type="text" id="package-course-type" required>
                    </div>
                    <div class="form-group">
                        <label for="package-price">价格</label>
                        <input type="number" id="package-price" step="0.01">
                    </div>
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeAddCoursePackageModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加活动规则模态框 -->
    <div id="add-activity-rule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加活动规则</h3>
                <span class="close" onclick="closeAddActivityRuleModal()">&times;</span>
            </div>
            <form id="add-activity-rule-form">
                <div class="form-group">
                    <label for="activity-name">活动名称</label>
                    <input type="text" id="activity-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="activity-course-type">课程类型</label>
                        <input type="text" id="activity-course-type" required>
                    </div>
                    <div class="form-group">
                        <label for="activity-days">天数</label>
                        <input type="number" id="activity-days" required>
                    </div>
                    <div class="form-group">
                        <label for="activity-total-hours">总课时</label>
                        <input type="number" id="activity-total-hours" required>
                    </div>
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeAddActivityRuleModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 编辑活动规则模态框 -->
    <div id="edit-activity-rule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑活动规则</h3>
                <span class="close" onclick="closeEditActivityRuleModal()">&times;</span>
            </div>
            <form id="edit-activity-rule-form">
                <input type="hidden" id="edit-activity-rule-id">
                <div class="form-group">
                    <label for="edit-activity-name">活动名称</label>
                    <input type="text" id="edit-activity-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-activity-course-type">课程类型</label>
                        <input type="text" id="edit-activity-course-type" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-activity-days">天数</label>
                        <input type="number" id="edit-activity-days" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-activity-total-hours">总课时</label>
                        <input type="number" id="edit-activity-total-hours" required>
                    </div>
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeEditActivityRuleModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 分配课程包模态框 -->
    <div id="assign-course-package-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">分配课程包</h3>
                <span class="close" onclick="closeAssignCoursePackageModal()">&times;</span>
            </div>
            <form id="assign-course-package-form">
                <div class="form-group">
                    <label for="assign-student">学生 <span style="color: red;">*</span></label>
                    <select id="assign-student" required></select>
                </div>
                <div class="form-group">
                    <label for="assign-course-package">课程包 <span style="color: red;">*</span></label>
                    <select id="assign-course-package" required></select>
                </div>

                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeAssignCoursePackageModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑学生模态框 -->
    <div id="edit-student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑学生</h3>
                <span class="close" onclick="closeEditStudentModal()">&times;</span>
            </div>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id">
                <div class="form-group">
                    <label for="edit-student-name">姓名 <span style="color: red;">*</span></label>
                    <input type="text" id="edit-student-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-student-nickname">昵称</label>
                    <input type="text" id="edit-student-nickname">
                </div>
                <div class="form-group">
                    <label for="edit-student-parent-contact">联系方式</label>
                    <input type="text" id="edit-student-parent-contact">
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeEditStudentModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑课程包模态框 -->
    <div id="edit-course-package-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑课程包</h3>
                <span class="close" onclick="closeEditCoursePackageModal()">&times;</span>
            </div>
            <form id="edit-course-package-form">
                <input type="hidden" id="edit-course-package-id">
                <div class="form-group">
                    <label for="edit-package-name">名称 <span style="color: red;">*</span></label>
                    <input type="text" id="edit-package-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-package-total-hours">总课时 <span style="color: red;">*</span></label>
                        <input type="number" id="edit-package-total-hours" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-package-course-type">课程类型 <span style="color: red;">*</span></label>
                        <input type="text" id="edit-package-course-type" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-package-price">价格</label>
                        <input type="number" id="edit-package-price" step="0.01">
                    </div>
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeEditCoursePackageModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API基础URL - 使用相对路径，自动适配不同环境
        const API_BASE_URL = '/api';

        // 当前页码、显示数量和筛选条件
        let currentStudentPage = 1;
        let studentPageSize = 10;
        let currentRecordPage = 1;
        let recordPageSize = 10;
        let recordStudentNameFilter = '';
        let recordCoursePackageFilter = '';

        // 页面加载完成后初始化数据
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadStudents();
            loadCoursePackages();
            loadActivityRules();
            loadRecords();
            loadCourseTypes();
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('consume-date').value = today;
        });

        // 切换标签页
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                
                // 移除所有标签页和内容的active类
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加当前标签页和内容的active类
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // 加载统计数据
        function loadStats() {
            fetch(`${API_BASE_URL}/stats`)
                .then(response => response.json())
                .then(data => {
                    const statsContainer = document.getElementById('stats');
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${data.total_students}</div>
                            <div class="stat-label">总学生数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.total_course_packages}</div>
                            <div class="stat-label">总课程包数</div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // 学生筛选条件
        let studentNameFilter = '';
        let studentCourseTypeFilter = '';

        // 加载学生列表
        function loadStudents(page = 1) {
            currentStudentPage = page;
            
            // 获取所有相关数据
            Promise.all([
                fetch(`${API_BASE_URL}/students?page=${page}&limit=${studentPageSize}${studentNameFilter ? `&name=${encodeURIComponent(studentNameFilter)}` : ''}`).then(res => res.json()),
                fetch(`${API_BASE_URL}/student-course-packages`).then(res => res.json()),
                fetch(`${API_BASE_URL}/course-packages`).then(res => res.json())
            ]).then(([students, studentCoursePackages, coursePackages]) => {
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                
                // 过滤学生
                let filteredStudents = students;
                if (studentCourseTypeFilter) {
                    // 获取当前课程类型对应的所有课程包ID
                    const relevantPackageIds = coursePackages
                        .filter(pkg => pkg.course_type === studentCourseTypeFilter)
                        .map(pkg => pkg.id);
                    
                    // 找出拥有这些课程包的学生ID
                    const relevantStudentIds = [...new Set(
                        studentCoursePackages
                            .filter(assoc => relevantPackageIds.includes(assoc.course_package_id))
                            .map(assoc => assoc.student_id)
                    )];
                    
                    // 过滤出相关学生
                    filteredStudents = students.filter(student => relevantStudentIds.includes(student.id));
                }
                
                filteredStudents.forEach(student => {
                    // 获取学生的课程包信息
                    const studentPackages = studentCoursePackages.filter(assoc => assoc.student_id === student.id);
                    
                    // 构建课程包信息字符串
                    const coursePackageInfo = studentPackages.map(assoc => {
                        const pkg = coursePackages.find(p => p.id === assoc.course_package_id);
                        return pkg ? `${pkg.name} (${pkg.course_type}): ${assoc.remaining_hours}课时` : `${assoc.course_package_id}: 课程包已删除`;
                    }).join('<br>') || '-';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.nickname || '-'}</td>
                        <td>${student.parent_contact || '-'}</td>
                        <td>${coursePackageInfo}</td>
                        <td>${new Date(student.created_at).toISOString().split('T')[0]}</td>
                        <td>
                            <button class="btn-primary" onclick="editStudent(${student.id})">&nbsp;编辑&nbsp;</button>
                            <button class="btn-danger" onclick="deleteStudent(${student.id})">&nbsp;删除&nbsp;</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 更新分页控件
                updateStudentsPagination(page);
            })
            .catch(error => {
                console.error('Error loading students:', error);
            });
        }

        // 筛选学生
        function filterStudents() {
            studentNameFilter = document.getElementById('student-name-filter').value;
            studentCourseTypeFilter = document.getElementById('student-course-type-filter').value;
            loadStudents(1);
        }

        // 重置学生筛选
        function resetStudentFilter() {
            document.getElementById('student-name-filter').value = '';
            document.getElementById('student-course-type-filter').value = '';
            studentNameFilter = '';
            studentCourseTypeFilter = '';
            loadStudents(1);
        }

        // 更新学生分页控件
        function updateStudentsPagination(currentPage) {
            const pagination = document.getElementById('students-pagination');
            pagination.innerHTML = `
                <button class="btn-secondary" onclick="loadStudents(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&nbsp;上一页&nbsp;</button>
                <span class="pagination-info">第 ${currentPage} 页</span>
                <button class="btn-secondary" onclick="loadStudents(${currentPage + 1})">下一页</button>
                <span>显示数量：</span>
                <select onchange="changeStudentPageSize(this.value)">
                    <option value="10" ${studentPageSize === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${studentPageSize === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${studentPageSize === 50 ? 'selected' : ''}>50</option>
                </select>
            `;
        }
        
        // 更改学生页面大小
        function changeStudentPageSize(size) {
            studentPageSize = parseInt(size);
            loadStudents(1);
        }

        // 打开添加学生模态框
        function openAddStudentModal() {
            document.getElementById('add-student-modal').style.display = 'block';
        }

        // 关闭添加学生模态框
        function closeAddStudentModal() {
            document.getElementById('add-student-modal').style.display = 'none';
            document.getElementById('add-student-form').reset();
        }

        // 添加学生表单提交
        document.getElementById('add-student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('student-name').value;
            const nickname = document.getElementById('student-nickname').value;
            const parent_contact = document.getElementById('student-parent-contact').value;
            
            fetch(`${API_BASE_URL}/students`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, nickname, parent_contact })
            })
            .then(response => response.json())
            .then(data => {
                closeAddStudentModal();
                loadStudents();
                loadStats();
                showAlert('学生添加成功', 'success');
            })
            .catch(error => {
                console.error('Error adding student:', error);
                showAlert('学生添加失败', 'error');
            });
        });

        // 打开分配课程包模态框
        function openAssignCoursePackageModal() {
            const studentSelect = document.getElementById('assign-student');
            const coursePackageSelect = document.getElementById('assign-course-package');
            
            // 清空并加载学生列表
            studentSelect.innerHTML = '<option value="">选择学生</option>';
            fetch(`${API_BASE_URL}/students`)
                .then(response => response.json())
                .then(students => {
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.nickname || ''})`;
                        studentSelect.appendChild(option);
                    });
                });
            
            // 清空并加载课程包列表
            coursePackageSelect.innerHTML = '<option value="">选择课程包</option>';
            fetch(`${API_BASE_URL}/course-packages`)
                .then(response => response.json())
                .then(coursePackages => {
                    coursePackages.forEach(pkg => {
                        const option = document.createElement('option');
                        option.value = pkg.id;
                        option.textContent = `${pkg.name} (${pkg.course_type})`;
                        coursePackageSelect.appendChild(option);
                    });
                });
            
            document.getElementById('assign-course-package-modal').style.display = 'block';
        }

        // 关闭分配课程包模态框
        function closeAssignCoursePackageModal() {
            document.getElementById('assign-course-package-modal').style.display = 'none';
            document.getElementById('assign-course-package-form').reset();
        }

        // 分配课程包表单提交
        document.getElementById('assign-course-package-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const student_id = parseInt(document.getElementById('assign-student').value);
            const course_package_id = parseInt(document.getElementById('assign-course-package').value);
            
            const data = {
                student_id,
                course_package_id
            };
            
            fetch(`${API_BASE_URL}/student-course-packages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                closeAssignCoursePackageModal();
                showAlert('课程包分配成功', 'success');
            })
            .catch(error => {
                console.error('Error assigning course package:', error);
                showAlert('课程包分配失败', 'error');
            });
        });

        // 打开编辑学生模态框
        function openEditStudentModal(id) {
            // 根据ID获取学生信息
            fetch(`${API_BASE_URL}/students?name=&limit=100`)
                .then(response => response.json())
                .then(students => {
                    const student = students.find(s => s.id === id);
                    if (student) {
                        document.getElementById('edit-student-id').value = student.id;
                        document.getElementById('edit-student-name').value = student.name;
                        document.getElementById('edit-student-nickname').value = student.nickname || '';
                        document.getElementById('edit-student-parent-contact').value = student.parent_contact || '';
                        document.getElementById('edit-student-modal').style.display = 'block';
                    }
                });
        }

        // 关闭编辑学生模态框
        function closeEditStudentModal() {
            document.getElementById('edit-student-modal').style.display = 'none';
            document.getElementById('edit-student-form').reset();
        }

        // 编辑学生表单提交
        document.getElementById('edit-student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-student-id').value);
            const name = document.getElementById('edit-student-name').value;
            const nickname = document.getElementById('edit-student-nickname').value;
            const parent_contact = document.getElementById('edit-student-parent-contact').value;
            
            fetch(`${API_BASE_URL}/students/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, nickname, parent_contact })
            })
            .then(response => response.json())
            .then(data => {
                closeEditStudentModal();
                loadStudents();
                showAlert('学生编辑成功', 'success');
            })
            .catch(error => {
                console.error('Error editing student:', error);
                showAlert('学生编辑失败', 'error');
            });
        });

        // 编辑学生
        function editStudent(id) {
            openEditStudentModal(id);
        }

        // 删除学生
        function deleteStudent(id) {
            if (confirm('确定要删除该学生吗？')) {
                fetch(`${API_BASE_URL}/students/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    loadStudents();
                    loadStats();
                    showAlert('学生删除成功', 'success');
                })
                .catch(error => {
                    console.error('Error deleting student:', error);
                    showAlert('学生删除失败', 'error');
                });
            }
        }

        // 加载课程包列表
        function loadCoursePackages() {
            fetch(`${API_BASE_URL}/course-packages`)
                .then(response => response.json())
                .then(coursePackages => {
                    const tbody = document.querySelector('#course-packages-table tbody');
                    tbody.innerHTML = '';
                    
                    coursePackages.forEach(package => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${package.name}</td>
                            <td>${package.total_hours}</td>
                            <td>${package.course_type}</td>
                            <td>${package.price || '-'}</td>
                            <td>${new Date(package.created_at).toISOString().split('T')[0]}</td>
                            <td>
                                <button class="btn-primary" onclick="editCoursePackage(${package.id})">&nbsp;编辑&nbsp;</button>
                                <button class="btn-danger" onclick="deleteCoursePackage(${package.id})">&nbsp;删除&nbsp;</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 消课管理中的课程包通过课程类型动态加载，不需要这里填充
                    
                    // 填充消课记录筛选中的课程包下拉框
                    const recordCoursePackageSelect = document.getElementById('record-course-package-filter');
                    recordCoursePackageSelect.innerHTML = '<option value="">所有课程包</option>';
                    coursePackages.forEach(pkg => {
                        const option = document.createElement('option');
                        option.value = pkg.id;
                        option.textContent = `${pkg.name} (${pkg.course_type})`;
                        recordCoursePackageSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading course packages:', error);
                });
        }

        // 打开添加课程包模态框
        function openAddCoursePackageModal() {
            document.getElementById('add-course-package-modal').style.display = 'block';
        }

        // 关闭添加课程包模态框
        function closeAddCoursePackageModal() {
            document.getElementById('add-course-package-modal').style.display = 'none';
            document.getElementById('add-course-package-form').reset();
        }

        // 添加课程包表单提交
        document.getElementById('add-course-package-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('package-name').value;
            const total_hours = parseInt(document.getElementById('package-total-hours').value);
            const course_type = document.getElementById('package-course-type').value;
            const price = parseFloat(document.getElementById('package-price').value) || null;
            
            fetch(`${API_BASE_URL}/course-packages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, total_hours, course_type, price })
            })
            .then(response => response.json())
            .then(data => {
                closeAddCoursePackageModal();
                loadCoursePackages();
                loadStats();
                loadCourseTypes();
                showAlert('课程包添加成功', 'success');
            })
            .catch(error => {
                console.error('Error adding course package:', error);
                showAlert('课程包添加失败', 'error');
            });
        });

        // 打开编辑课程包模态框
        function openEditCoursePackageModal(id) {
            // 根据ID获取课程包信息
            fetch(`${API_BASE_URL}/course-packages?limit=100`)
                .then(response => response.json())
                .then(coursePackages => {
                    const coursePackage = coursePackages.find(pkg => pkg.id === id);
                    if (coursePackage) {
                        document.getElementById('edit-course-package-id').value = coursePackage.id;
                        document.getElementById('edit-package-name').value = coursePackage.name;
                        document.getElementById('edit-package-total-hours').value = coursePackage.total_hours;
                        document.getElementById('edit-package-course-type').value = coursePackage.course_type;
                        document.getElementById('edit-package-price').value = coursePackage.price || '';
                        document.getElementById('edit-course-package-modal').style.display = 'block';
                    }
                });
        }

        // 关闭编辑课程包模态框
        function closeEditCoursePackageModal() {
            document.getElementById('edit-course-package-modal').style.display = 'none';
            document.getElementById('edit-course-package-form').reset();
        }

        // 编辑课程包表单提交
        document.getElementById('edit-course-package-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-course-package-id').value);
            const name = document.getElementById('edit-package-name').value;
            const total_hours = parseInt(document.getElementById('edit-package-total-hours').value);
            const course_type = document.getElementById('edit-package-course-type').value;
            const price = document.getElementById('edit-package-price').value;
            
            const data = {
                name,
                total_hours,
                course_type,
                price: price ? parseFloat(price) : null
            };
            
            fetch(`${API_BASE_URL}/course-packages/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                closeEditCoursePackageModal();
                loadCoursePackages();
                loadCourseTypes();
                showAlert('课程包编辑成功', 'success');
            })
            .catch(error => {
                console.error('Error editing course package:', error);
                showAlert('课程包编辑失败', 'error');
            });
        });

        // 编辑课程包
        function editCoursePackage(id) {
            openEditCoursePackageModal(id);
        }

        // 删除课程包
        function deleteCoursePackage(id) {
            if (confirm('确定要删除该课程包吗？')) {
                fetch(`${API_BASE_URL}/course-packages/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    loadCoursePackages();
                    loadStats();
                    showAlert('课程包删除成功', 'success');
                })
                .catch(error => {
                    console.error('Error deleting course package:', error);
                    showAlert('课程包删除失败', 'error');
                });
            }
        }

        // 加载活动规则列表
        function loadActivityRules() {
            fetch(`${API_BASE_URL}/activity-rules`)
                .then(response => response.json())
                .then(activityRules => {
                    const tbody = document.querySelector('#activity-rules-table tbody');
                    tbody.innerHTML = '';
                    
                    activityRules.forEach(rule => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rule.name}</td>
                            <td>${rule.course_type}</td>
                            <td>${rule.days}</td>
                            <td>${rule.total_hours}</td>
                            <td>${rule.hours_per_class}</td>
                            <td>${new Date(rule.created_at).toISOString().split('T')[0]}</td>
                            <td>
                                <button class="btn-primary" onclick="openEditActivityRuleModal(${rule.id})">&nbsp;编辑&nbsp;</button>
                                <button class="btn-danger" onclick="deleteActivityRule(${rule.id})">&nbsp;删除&nbsp;</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 填充消课管理中的活动下拉框
                    const activitySelect = document.getElementById('consume-activity');
                    activitySelect.innerHTML = '<option value="">选择活动</option>';
                    activityRules.forEach(rule => {
                        const option = document.createElement('option');
                        option.value = rule.id;
                        option.textContent = `${rule.name} (${rule.course_type})`;
                        activitySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading activity rules:', error);
                });
        }

        // 打开添加活动规则模态框
        function openAddActivityRuleModal() {
            document.getElementById('add-activity-rule-modal').style.display = 'block';
        }

        // 关闭添加活动规则模态框
        function closeAddActivityRuleModal() {
            document.getElementById('add-activity-rule-modal').style.display = 'none';
            document.getElementById('add-activity-rule-form').reset();
        }

        // 添加活动规则表单提交
        document.getElementById('add-activity-rule-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('activity-name').value;
            const course_type = document.getElementById('activity-course-type').value;
            const days = parseInt(document.getElementById('activity-days').value);
            const total_hours = parseInt(document.getElementById('activity-total-hours').value);
            
            fetch(`${API_BASE_URL}/activity-rules`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, course_type, days, total_hours })
            })
            .then(response => response.json())
            .then(data => {
                closeAddActivityRuleModal();
                loadActivityRules();
                showAlert('活动规则添加成功', 'success');
            })
            .catch(error => {
                console.error('Error adding activity rule:', error);
                showAlert('活动规则添加失败', 'error');
            });
        });
        
        // 打开编辑活动规则模态框
        function openEditActivityRuleModal(id) {
            // 根据ID获取活动规则信息
            fetch(`${API_BASE_URL}/activity-rules`)
                .then(response => response.json())
                .then(activityRules => {
                    const activityRule = activityRules.find(rule => rule.id === id);
                    if (activityRule) {
                        document.getElementById('edit-activity-rule-id').value = activityRule.id;
                        document.getElementById('edit-activity-name').value = activityRule.name;
                        document.getElementById('edit-activity-course-type').value = activityRule.course_type;
                        document.getElementById('edit-activity-days').value = activityRule.days;
                        document.getElementById('edit-activity-total-hours').value = activityRule.total_hours;
                        document.getElementById('edit-activity-rule-modal').style.display = 'block';
                    }
                });
        }
        
        // 关闭编辑活动规则模态框
        function closeEditActivityRuleModal() {
            document.getElementById('edit-activity-rule-modal').style.display = 'none';
            document.getElementById('edit-activity-rule-form').reset();
        }
        
        // 编辑活动规则表单提交
        document.getElementById('edit-activity-rule-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-activity-rule-id').value);
            const name = document.getElementById('edit-activity-name').value;
            const course_type = document.getElementById('edit-activity-course-type').value;
            const days = parseInt(document.getElementById('edit-activity-days').value);
            const total_hours = parseInt(document.getElementById('edit-activity-total-hours').value);
            
            fetch(`${API_BASE_URL}/activity-rules/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, course_type, days, total_hours })
            })
            .then(response => response.json())
            .then(data => {
                closeEditActivityRuleModal();
                loadActivityRules();
                showAlert('活动规则编辑成功', 'success');
            })
            .catch(error => {
                console.error('Error editing activity rule:', error);
                showAlert('活动规则编辑失败', 'error');
            });
        });
        
        // 删除活动规则
        function deleteActivityRule(id) {
            if (confirm('确定要删除该活动规则吗？')) {
                fetch(`${API_BASE_URL}/activity-rules/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    loadActivityRules();
                    showAlert('活动规则删除成功', 'success');
                })
                .catch(error => {
                    console.error('Error deleting activity rule:', error);
                    showAlert('活动规则删除失败', 'error');
                });
            }
        }

        // 加载课程类型
        function loadCourseTypes() {
            fetch(`${API_BASE_URL}/course-packages`)
                .then(response => response.json())
                .then(coursePackages => {
                    const courseTypes = [...new Set(coursePackages.map(pkg => pkg.course_type))];
                    
                    // 填充消课管理页面的课程类型下拉框
                    const consumeCourseTypeSelect = document.getElementById('consume-course-type');
                    consumeCourseTypeSelect.innerHTML = '<option value="">选择课程类型</option>';
                    courseTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        consumeCourseTypeSelect.appendChild(option);
                    });
                    
                    // 填充学生管理页面的课程类型筛选下拉框
                    const studentCourseTypeSelect = document.getElementById('student-course-type-filter');
                    studentCourseTypeSelect.innerHTML = '<option value="">选择课程类型</option>';
                    courseTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        studentCourseTypeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading course types:', error);
                });
        }

        // 根据课程类型加载学生（拥有对应课程包的学生）
        function loadStudentsByCourseType() {
            const courseType = document.getElementById('consume-course-type').value;
            const studentsContainer = document.getElementById('consume-students');
            const activitySelect = document.getElementById('consume-activity');
            const consumeHoursInput = document.getElementById('consume-hours');
            
            // 重置相关表单
            studentsContainer.innerHTML = '';
            activitySelect.innerHTML = '<option value="">选择活动</option>';
            consumeHoursInput.value = '';
            
            // 显示提示信息
            if (!courseType) {
                studentsContainer.innerHTML = '<p>请先选择课程类型</p>';
                return;
            }
            
            // 加载所有学生课程包关联，然后过滤出拥有对应课程类型的学生
            Promise.all([
                fetch(`${API_BASE_URL}/students`).then(res => res.json()),
                fetch(`${API_BASE_URL}/student-course-packages`).then(res => res.json()),
                fetch(`${API_BASE_URL}/course-packages`).then(res => res.json()),
                fetch(`${API_BASE_URL}/activity-rules`).then(res => res.json())
            ]).then(([students, studentCoursePackages, coursePackages, activityRules]) => {
                // 获取当前课程类型对应的所有课程包ID
                const relevantPackageIds = coursePackages
                    .filter(pkg => pkg.course_type === courseType)
                    .map(pkg => pkg.id);
                
                // 找出拥有这些课程包的学生ID
                const relevantStudentIds = [...new Set(
                    studentCoursePackages
                        .filter(assoc => relevantPackageIds.includes(assoc.course_package_id))
                        .map(assoc => assoc.student_id)
                )];
                
                // 过滤出相关学生
                const relevantStudents = students.filter(student => relevantStudentIds.includes(student.id));
                
                if (relevantStudents.length === 0) {
                    studentsContainer.innerHTML = '<p>当前课程类型下没有学生</p>';
                    return;
                }
                
                // 显示学生列表，包含课程包剩余课时
                relevantStudents.forEach(student => {
                    // 找出该学生对应的课程包关联
                    const studentPackages = studentCoursePackages.filter(assoc => 
                        assoc.student_id === student.id && relevantPackageIds.includes(assoc.course_package_id)
                    );
                    
                    // 获取剩余课时信息
                    const remainingHoursInfo = studentPackages.map(assoc => {
                        const pkg = coursePackages.find(p => p.id === assoc.course_package_id);
                        return `${pkg.name}: ${assoc.remaining_hours}课时`;
                    }).join('<br>');
                    
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" name="student_ids" value="${student.id}">
                        <label>
                            <strong>${student.name}</strong> (${student.nickname || ''})<br>
                            <small style="color: #666;">${remainingHoursInfo}</small>
                        </label>
                    `;
                    studentsContainer.appendChild(checkboxItem);
                });
                
                // 加载当前课程类型对应的活动
                    const relevantActivities = activityRules.filter(rule => rule.course_type === courseType);
                    
                    // 启用活动选择框
                    activitySelect.disabled = false;
                    
                    if (relevantActivities.length > 0) {
                        activitySelect.innerHTML = '<option value="">选择活动</option>';
                        relevantActivities.forEach(activity => {
                            const option = document.createElement('option');
                            option.value = activity.id;
                            option.textContent = `${activity.name} (${activity.hours_per_class}课时/节)`;
                            activitySelect.appendChild(option);
                        });
                    } else {
                        activitySelect.innerHTML = '<option value="">当前课程无活动</option>';
                    }
                
                // 默认消耗课时为1
                consumeHoursInput.value = '1';
            })
            .catch(error => {
                console.error('Error loading students by course type:', error);
                studentsContainer.innerHTML = '<p>加载学生失败</p>';
            });
        }

        // 根据活动更新消耗课时
        function updateConsumeHours() {
            const activityId = parseInt(document.getElementById('consume-activity').value);
            if (!activityId) {
                // 取消选择活动时，恢复消耗课时为默认值1
                document.getElementById('consume-hours').value = '1';
                return;
            }
            
            // 获取活动规则，更新消耗课时
            fetch(`${API_BASE_URL}/activity-rules`)
                .then(response => response.json())
                .then(activityRules => {
                    const activity = activityRules.find(rule => rule.id === activityId);
                    if (activity) {
                        document.getElementById('consume-hours').value = activity.hours_per_class;
                    }
                })
                .catch(error => {
                    console.error('Error loading activity rules:', error);
                });
        }

        // 批量消课
        function consumeHours() {
            const studentCheckboxes = document.querySelectorAll('input[name="student_ids"]:checked');
            const student_ids = Array.from(studentCheckboxes).map(checkbox => parseInt(checkbox.value));
            const activity_id = parseInt(document.getElementById('consume-activity').value) || null;
            const hours_consumed = parseFloat(document.getElementById('consume-hours').value);
            const remark = document.getElementById('consume-remark').value;
            const course_type = document.getElementById('consume-course-type').value;
            const consume_date = document.getElementById('consume-date').value;
            
            if (student_ids.length === 0) {
                alert('请选择至少一个学生');
                return;
            }
            
            if (!course_type) {
                alert('请选择课程类型');
                return;
            }
            
            if (isNaN(hours_consumed) || hours_consumed <= 0) {
                alert('请输入有效的消耗课时');
                return;
            }
            
            // 执行消课
            fetch(`${API_BASE_URL}/consume`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    student_ids, 
                    activity_id, 
                    remark,
                    hours_consumed,
                    consume_date
                })
            })
            .then(response => response.json())
            .then(data => {
                // 清空选择的学生和表单
                document.querySelectorAll('input[name="student_ids"]:checked').forEach(checkbox => checkbox.checked = false);
                document.getElementById('consume-course-type').value = '';
                document.getElementById('consume-activity').value = '';
                document.getElementById('consume-hours').value = '';
                document.getElementById('consume-remark').value = '';
                document.getElementById('consume-students').innerHTML = '';
                
                // 重新加载相关数据
                loadStats();
                loadRecords();
                loadStudents();
                loadCourseTypes();
                
                // 显示详细的消课结果
                if (data.success_count > 0) {
                    showAlert(`消课成功！成功：${data.success_count}人，失败：${data.failed_count}人`, 'success');
                } else {
                    showAlert(`消课失败！共${data.failed_count}人消课失败`, 'error');
                }
            })
            .catch(error => {
                console.error('Error consuming hours:', error);
                showAlert('消课失败', 'error');
            });
        }

        // 加载消课记录
        function loadRecords(page = 1) {
            currentRecordPage = page;
            let url = `${API_BASE_URL}/consumption-records?page=${page}&limit=${recordPageSize}`;
            if (recordStudentNameFilter) {
                url += `&student_name=${encodeURIComponent(recordStudentNameFilter)}`;
            }
            if (recordCoursePackageFilter) {
                url += `&course_package=${recordCoursePackageFilter}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(records => {
                    const tbody = document.querySelector('#records-table tbody');
                    tbody.innerHTML = '';
                    
                    records.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.student_name}</td>
                            <td>${record.package_name}</td>
                            <td>${record.activity_name || '-'}</td>
                            <td>${record.hours_consumed}</td>
                            <td>${new Date(record.consume_date).toISOString().split('T')[0]}</td>
                            <td>${record.remark || '-'}</td>
                            <td>
                                <button class="btn-danger" onclick="cancelConsumption(${record.id})">&nbsp;撤销&nbsp;</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页控件
                    updateRecordsPagination(page);
                })
                .catch(error => {
                    console.error('Error loading records:', error);
                });
        }

        // 筛选消课记录
        function filterRecords() {
            recordStudentNameFilter = document.getElementById('record-student-name').value;
            recordCoursePackageFilter = document.getElementById('record-course-package-filter').value;
            loadRecords(1);
        }

        // 重置消课记录筛选
        function resetRecordFilter() {
            document.getElementById('record-student-name').value = '';
            document.getElementById('record-course-package-filter').value = '';
            recordStudentNameFilter = '';
            recordCoursePackageFilter = '';
            loadRecords(1);
        }

        // 更新消课记录分页控件
        function updateRecordsPagination(currentPage) {
            const pagination = document.getElementById('records-pagination');
            pagination.innerHTML = `
                <button class="btn-secondary" onclick="loadRecords(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&nbsp;上一页&nbsp;</button>
                <span class="pagination-info">第 ${currentPage} 页</span>
                <button class="btn-secondary" onclick="loadRecords(${currentPage + 1})" >&nbsp;下一页&nbsp;</button>
                <span>显示数量：</span>
                <select onchange="changeRecordPageSize(this.value)">
                    <option value="10" ${recordPageSize === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${recordPageSize === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${recordPageSize === 50 ? 'selected' : ''}>50</option>
                </select>
            `;
        }
        
        // 更改消课记录页面大小
        function changeRecordPageSize(size) {
            recordPageSize = parseInt(size);
            loadRecords(1);
        }

        // 撤销消课记录
        function revertRecord(id) {
            if (confirm('确定要撤销该消课记录吗？')) {
                fetch(`${API_BASE_URL}/consumption-records/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    loadRecords(currentRecordPage);
                    loadStats();
                    loadStudents();
                    showAlert('消课记录撤销成功', 'success');
                })
                .catch(error => {
                    console.error('Error reverting record:', error);
                    showAlert('消课记录撤销失败', 'error');
                });
            }
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // 添加到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒后自动移除
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 点击模态框外部关闭模态框
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
    
    <footer style="text-align: center; margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-top: 1px solid #e9ecef; color: #6c757d; font-size: 14px;">
        <p>制作者: 雁归南研究所</p>
        <p>
            <a href="https://xhslink.com/m/8a9mUSoO1ZQ" target="_blank" style="color: #6c757d; text-decoration: none;">小红书</a>
            &nbsp;|&nbsp;
            <a href="https://afdian.com/a/Rashida" target="_blank" style="color: #6c757d; text-decoration: none;">爱发电</a>
        </p>
    </footer>
</body>
</html>